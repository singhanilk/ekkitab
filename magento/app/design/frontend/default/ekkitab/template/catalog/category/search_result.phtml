<?php
/**
 * 
 * Frontend  Catalog Category search results template
 * @category   design/ekkitab
 * @author Anisha (anisha@ekkitab.com)
 * @version 1.0 Dec 7, 2009
 * 
 * @copyright  COPYRIGHT (C) 2009 Ekkitab Educational Services India Pvt. Ltd.
 * @license    All Rights Reserved. All material contained in this file (including, but not limited to, text, images, graphics, HTML, programming code and scripts) 
 * constitute proprietary and  * confidential information protected by copyright laws, trade secret and other laws. No part of this software may be copied, reproduced, modified or 
 * distributed in any form or by any means, or stored in a database or retrieval system without the prior written permission of Ekkitab Educational Services.
 * 
 * 
 */
?>
<div class="leftNavArea">
<?php
	$results=$this->getProductCollection();
	$repArr1= array(" & ",
					"&");
	$repArr2= array(" (",
					"(",
					") ",
					")",
					": ",
					":",
					", ",
					",",
					";",
					" ");
if(!is_null($results)){
  $bookList = $results->get("books");
  if (!java_is_null($bookList)) {
	$count = java_values($bookList->size());
	$subcats = $results->get("counts");
	$curr_cp = $this->getCurrentCategoryPath();
	if (!java_is_null($subcats)) {
	  $retsize = java_values($subcats->size());
	  //echo "Size of Category List:[" . $retsize . "]\n"; 
	  $keys = $subcats->keySet();
	  if($retsize > 0){
?>
	<!-- linkHdr -->
	<div class="linkHdr">Search in Category </div>
		<ul>
<?php
		foreach($keys as $key): 
			$val = java_values($subcats->get($key));
			$key =  java_values($key);
			$urlKey = $key;
			$urlKey = str_replace($repArr1, "_", $urlKey);
			$urlKey = preg_replace('#[^A-Za-z0-9\_]+#', '-', $urlKey);//($repArr2, "-", $urlKey);
			
			//this is to remove - from end of string
			if(substr($urlKey,-1,1)=='-'){
				$urlKey = substr($urlKey,0,-1);
			}
			// this is to append the child categories to the link.
			if(isset($curr_cp) && strlen($curr_cp) > 0 ){
				$cp =  $curr_cp."__". urlencode($urlKey);
			}else{
				$cp =  urlencode($urlKey);
			}
?>		<li><a href="<?php echo $this->getSubCategorySearchUrl($cp,1) ?>"><?php echo $key. "[". $val ."]"?></a></li>
<?php	endforeach;	?>
	</ul>
	<div class="seeAll"><!--a href="#">See all &raquo;</a-->&nbsp;</div><!-- seeAll -->
<?php 	} //end of if(retsize > 0)
	} //end of if(!java_is_null(subcats))
?>
<?php if($count >0 ): ?>
	<?php echo $this->getDonateBlurbHtml() ?>
</div><!-- leftNavArea inside checks -->
<div class="mainArea">
<div class="inLeft">
<?php echo $this->getMessagesBlock()->getGroupedHtml()  ?>
	<?php if ($messages = $this->getNoteMessages()):?>
	<div class="note-msg">
		<?php foreach ($messages as $message):?>
		<?php echo $message?><br />
		<?php endforeach;?>
	</div>
	<?php endif; ?>
	<?php //echo $this->getToolbarHtml()
	?>
<div class="searchResTop">
	<div class="leftArea">
		<?php if($this->getLastPageNumber()>1): ?>
			<?php echo $this->__('Showing %s to %s of %s books', $this->getFirstNum(), $this->getLastNum(), $this->getTotalNum()) ?>
		<?php elseif($this->getTotalNum()==1): ?>
			<?php echo $this->__('Showing the only book', $this->getTotalNum()) ?>
		<?php else: ?>
			<?php echo $this->__('Showing all %s books', $this->getTotalNum()) ?>
		<?php endif; ?>
		<!--<?php echo $this->__("results for '%s'", $this->helper('ekkitab_catalogsearch')->getEscapedQueryText()) ?>-->
	</div><!-- leftArea -->

	<div class="rightArea">
		<div class="topPaginationArea">
			<?php if($this->getLastPageNumber()>1): ?>
			<ul>
				<?php if (!$this->isFirstPage()): ?>
					<li><a href="<?php echo $this->getPreviousPageUrl() ?>" id="prev"><?php echo $this->__('Prev') ?></a></li>
				<?php else: ?>
					<li class="nolink"><?php echo $this->__('Prev') ?></li>
				<?php endif; ?>
				
				<?php foreach ($this->getPages() as $_page): ?>
					<?php if ($this->isPageCurrent($_page)): ?>
						<li><span><?php echo $_page ?></span></li>
					<?php else: ?>
						<li><a href="<?php echo $this->getPageUrl($_page) ?>"><?php echo $_page ?></a></li>
					<?php endif ?>
				<?php endforeach; ?>

				<?php if (!$this->isLastPage()): ?>
					<li><a href="<?php echo $this->getNextPageUrl() ?>"><?php echo $this->__('Next') ?></a></li>
				<?php else: ?>
					<li><b id="sep"><?php echo $this->__('Next') ?></b></li>
				<?php endif; ?>

			</ul>
			<?php endif; ?>
		</div>
	</div><!-- rightArea -->
	<div class="clear"></div>
</div><!-- searchResTop -->
	<?php 
		$iter = $bookList->iterator();
		for ($j=0; $j<$count; $j++) {
			$book = $bookList->get($j);
			$author = strlen($book->get("author")) > 0 ? $book->get("author") : "Unknown";
			$title = $book->get("title");
			$image = $book->get("image");
			$id = $book->get("entityId");
			$listPrice = java_values($book->get("listprice")) ;
			$discPrice = java_values($book->get("discountprice"));
			$isbn = java_values($book->get("isbn"));
			$shippingTime=java_values($book->get("delivertime"));
			$binding=strlen($book->get("binding")) > 0 ? ucfirst($book->get("binding")) : "Not Available" ;
			$language=strlen($book->get("language")) > 0 ? $book->get("language") : "Unknown";
			$stock=java_values($book->get("instock"));
			$shortDesc=java_values($book->get("shortdesc"));
			//$url = $book->get("url");
			//$url="catalog/product/view/id/".$id;

			//further alterations.
			$savings= $listPrice - $discPrice;
			$savingsPerct= ($listPrice >0 )? (($listPrice - $discPrice)/ $listPrice ) * 100 : 0;
			$shippingTime= $shippingTime  > 0 ? "Normally Ships in ".$shippingTime. ($shippingTime  == 1 ? " day":" days"): "";
			$shortDesc= ($shortDesc =="Not Available") ? "" : $shortDesc;
			
			if(isset($author) && strlen(trim($author)) > 0)
			{
				$bookName=$author."__";
			}else{
				$bookName="";
			}
			$bookName=$bookName.$title."__".$id;
			$bookName = preg_replace('#[^A-Za-z0-9\_]+#', '-', $bookName);//($repArr2, "-", $urlKey);
			$url="ekkitab_catalog/product/view/book/".$bookName.".html";
			
	?>
			<!-- searchRowBegins -->
			<div class="searchRow">
			<div class="skuImage"><div class="image"><a href="<?php echo $this->getUrl($url)?>" title="<?php  echo $title?>">
				<img src="<?php echo $this->helper('ekkitab_catalogsearch')->resize($image,'small_image',false,null, 109); ?>" alt="<?php echo $title?>"></a></div></div>
			<!-- skuImage -->
			<div class="detailsArea">
			<div class="bkTitle"><a href="<?php echo $this->getUrl($url)?>" title="<?php echo $title ?>"><?php echo $title ?></a></div><!-- bkTitle -->
			<div class="lineHeight14em">Author: <?php echo $author ?></div>
			<div class="lineHeight14em">ISBN:  <?php echo $isbn ?></div>
			<div class="lineHeight14em">Binding: <?php echo $binding ?></div>
			<div class="lineHeight14em">Language : <?php echo $language ?></div>
			<div class="synop"><?php echo $shortDesc ?>... <a href="<?php echo $this->getUrl($url)?>" title="<?php echo $title ?>">More details</a></div><!-- synop -->
			</div><!-- detailsArea -->

			<div class="priceArea">
			<div class="youSave">Our Price: <?php echo Mage::helper('core')->currency($discPrice,true,false) ?></div>
			<div class="lineHeight14em">MRP Price : <?php echo Mage::helper('core')->currency($listPrice,true,false) ?></div>
			<div class="youSave">Save <?php echo Mage::helper('core')->currency($savings,true,false) ?> (<?php echo number_format($savingsPerct,2,'.','') ?>%)</div>
			<div class="lineHeight14em"><?php echo $shippingTime ?></div>
			<div class="youSave"><?php if($stock) { ?>In Stock<?php } else{?>Out of Stock<?php }?></div>
			<a href="<?php echo $this->getAddToWishlistUrl($id)?>"><?php echo $this->__('Add to Wishlist') ?></a><br/>
			
			<!--a href="#" onclick="setLocation('<?php echo $this->getAddToCartUrl($id)?>')"><img src="<?php echo $this->getSkinUrl('images/btn_add_to_cart.gif') ?>" alt="<?php echo $this->__('Add to Cart') ?>"></a-->
			</div><!-- priceArea -->
			<div class="clear"></div>
			</div><!-- searchRowEnds -->
			<div class="clear"></div>
		<?php } ?>
	</div><!-- inLeft-->
<div class="clear"></div>
	<div class="paginationAreaOut">
		<div class="paginationArea">
			<?php if($this->getLastPageNumber()>1): ?>
			<ul>
				<?php if (!$this->isFirstPage()): ?>
					<li><a href="<?php echo $this->getPreviousPageUrl() ?>" id="prev"><?php echo $this->__('Prev') ?></a></li>
				<?php else: ?>
					<li class="nolink"><?php echo $this->__('Prev') ?></li>
				<?php endif; ?>
				
				<?php foreach ($this->getPages() as $_page): ?>
					<?php if ($this->isPageCurrent($_page)): ?>
						<li><span><?php echo $_page ?></span></li>
					<?php else: ?>
						<li><a href="<?php echo $this->getPageUrl($_page) ?>"><?php echo $_page ?></a></li>
					<?php endif ?>
				<?php endforeach; ?>

				<?php if (!$this->isLastPage()): ?>
					<li><a href="<?php echo $this->getNextPageUrl() ?>"><?php echo $this->__('Next') ?></a></li>
				<?php else: ?>
					<li><b id="sep"><?php echo $this->__('Next') ?></b></li>
				<?php endif; ?>
			</ul>
			<?php endif; ?>
			<div class="clear"></div>
		</div><!-- paginationArea-->
	</div><!-- paginationAreaOut-->

</div><!-- mainArea -->

<?php else: //else of if(count >0 ) ?>
    	<?php echo $this->getDonateBlurbHtml() ?>
	</div><!-- leftNavArea -->
	<!--div class="page-head">
        <h3><?php echo ($this->getHeaderText() || $this->getHeaderText() === false) ? $this->getHeaderText() : $this->__("Search results for '%s'", $this->helper('ekkitab_catalogsearch')->getEscapedQueryText()) ?></h3>
    </div-->
	<div class="mainArea">
		<div class="inLeft">
			<div class="note-msg">
				<?php echo ($this->getNoResultText()) ? $this->getNoResultText() : $this->__('Your search returns no results.') ?>
				<?php if ($messages = $this->getNoteMessages()):?>
					<?php foreach ($messages as $message):?>
					<br /><?php echo $message?>
					<?php endforeach;?>
				<?php endif; ?>
			</div>
			<div class="padder">
				<div class="note-msg">
					<?php echo $this->__('There are no products matching the selection.') ?>
				</div>
			</div>
		</div>
	</div>

<?php endif;
} else { // else of if (!java_is_null(bookList)) {

?>
   	<?php echo $this->getDonateBlurbHtml() ?>
	</div><!-- leftNavArea -->
 <!--div class="page-head">
        <h3><?php echo ($this->getHeaderText() || $this->getHeaderText() === false) ? $this->getHeaderText() : $this->__("Search results for '%s'", $this->helper('ekkitab_catalogsearch')->getEscapedQueryText()) ?></h3>
    </div-->
	<div class="mainArea">
		<div class="inLeft">
			<div class="note-msg"> Sorry, we are unable to process your request now. Please try again later or write to us if the problem persists.</div>
		</div>
    </div>
<?php }
} // ending if(!is_null(results)){ no else part right now.
?>
