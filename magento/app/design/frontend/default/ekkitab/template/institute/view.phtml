<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Ekkitab_Catalog_Block_Product_View
 */
?>
<?php Mage::app()->getLayout()->getMessagesBlock()->setMessages(Mage::getSingleton('customer/session')->getMessages(true)); ?> 
<?php
	$_institute = $this->getInstitute();
	
	function getDisplayPagesArray($i,$pages){
		$displayPages=array();
		if ($pages <= 5) {
			$displayPages = range(1,$pages);
		}
		else {
			$half = ceil(5 / 2);
			if ($i >= $half && $i <= $pages - $half) {
				$start  = ($i - $half) + 1;
				$finish = ($start + 5) - 1;
			}
			elseif ($i < $half) {
				$start  = 1;
				$finish = 5;
			}
			elseif ($i > ( $pages- $half)) {
				$finish = $pages;
				$start  = $finish - 5 + 1;
			}

			$displayPages = range($start, $finish);
		}
        return $displayPages;
	}
	if(!is_null($_institute)){
		$image = $_institute->getImage();
?>
<div class="instituteArea">
	<div id="messages_product_view"><?php echo $this->getMessagesBlock()->getGroupedHtml() ?></div>
	
	<div class="midArea">
		<div class="finDetBkTitle"><?php echo $_institute->getName() ?> </div><!-- authorEtc -->
		<div class="finDetSynop">
			<div class="bigImage">
			   <img src="<?php echo $this->helper('ekkitab_institute')->resize($image,'image',false,220, null); ?>"><br/>
			</div>
			<?php $desc = $_institute->getAboutus();?>
			<?php if(trim($desc) !=''){ ?>
				 <?php echo $desc; ?>
			<?php } else{ ?>
				 Ekkitab welcomes '<?php echo $_institute->getName() ?>' to our Network.
			<?php } ?>
			<br/><br/>
			<?php $address = $_institute->getStreet()."<br/> ".$_institute->getLocality().", ".$_institute->getCity()."<br/>".$_institute->getState()."  ".$_institute->getPostcode();
				  if($_institute->getCountryId()!=""){
					 $country = Mage::getModel('directory/country')->loadByCode($_institute->getCountryId());
					 if($country->getName()!=""){
						$address.=("<br/>".$country->getName());
					}
				}			
			?>
				
			<strong>Address:</strong><br/>
			<?php echo $address; ?>
			<br/><strong>Ph: </strong><?php echo $_institute->getTelephone(); ?>

<?php	if($this->isUserAdmin()):
?>		
		  <br/><br/>
		  <a name="updateWishlistForm"></a>
		  <a href="javascript:gotoWishlistForm();" onClick="javascript:showWishlistForm();"><img src="<?php echo $this->getSkinUrl('images/btn_update_wishlist.gif') ?>" border="0"></a><br/>
		  <div class="padderTop15px" id="wishlistForm" style="display:none">
		  <form action="<?php echo $this->getOrgWishlistActionUrl($_institute->getId())?>" method="post">
				<label for="email_address"><?php echo $this->__("Please enter comma seperated list of book isbns you would like to add in your wishlist.") ?></label><br/>
				<textarea name="wishlist_isbns" id="wishlist_isbns" title="<?php echo $this->__('Wishlist Isbns') ?>" class="required-entry" rows="2" cols="120"></textarea>
				<ul class="form-list">
					<li><input type="image" src="<?php echo $this->getSkinUrl('images/submit_button.png') ?>" alt="<?php echo $this->__('Submit') ?>"/></li>
				</ul>
		</form>or

		<strong><a href="<?php echo $this->getWishlistBrowseUrl($_institute->getId())?>">Click here</a> to visit our bookstore and add books to your school's wishlist.</strong>

		</div>
<?php endif; ?>
		<div class="clear"></div>
		</div><!-- finDetSynop -->
<?php	$orgWishlist = 	$this->getOrganizationWishlist();
		if($orgWishlist->getSize()): 
   		  $itemIds = $orgWishlist->getAllIds();
		  $count=$orgWishlist->getSize();
		  $columnSize=3;
  		  $rowSize = 5;
		  $counter=0;
	      $firstTime=0;
		  $pageSize=$columnSize * $rowSize;
		  $pages=0;
		  if($count > 0){
			$pages = intval($count/ $pageSize);
			$pages = ($count % $pageSize) > 0 ? $pages +1 : $pages  ;
		  }else{
			$pages=0;
		  }
		  $displayPages = array();

		?>
	<script language="javascript">
		var totalPageCount=<?php echo $pages ?>;
		var pageSize=<?php echo $pageSize ?>;
		var totalWishlistCount=<?php echo $count ?>;
		var totalDonationCartItems=0;
		var totalDonationCost=0;
	</script>
	<div class="wishlistHdr">&nbsp;<?php echo $this->__("Our Library Needs") ?>
	
	<?php if($_institute->getAnyDonation()): ?>
	 <span class="greyTxtBoldIt">( <?php echo $this->__("We welcome any other book donation in addition to the list below.") ?> <a href="#anydonation">Click here</a> to know how.)</span>
	<?php endif; ?>
	</div>
	<form name="school_wishlist_books" action="<?php echo $this->getMoveSelectedCartUrl()?>" method="post">
	<?php for ($i=1; $i <=$pages ;$i++ ){
			$displayPages =getDisplayPagesArray($i,$pages);
	?>
	<div id="school_wishlist_page_<?php echo $i?>" style="display:<?php echo ($i > 1)?  "none": "block" ?>;">
		<div class="searchResTop">
 			<div class="leftArea">
				<div class="left">
				<?php if($this->isSaleable()  && !$this->isUserAdmin()):?>
					&nbsp; <input type="checkbox" onChange="javascript:selectAllBooks(<?php echo $i?>);" value="1" id="selectAll_<?php echo $i?>" />
					&nbsp; <input type="image"  src="<?php echo $this->getSkinUrl('images/donate_bks_selected.jpg');?>" alt="<?php echo $this->__('Donate Selected to Cart') ?>" />&nbsp;
			  <?php endif;?>
				<?php if($this->isUserAdmin()): ?>
					&nbsp; <input type="checkbox" onChange="javascript:selectAllBooks(<?php echo $i?>);" value="1" id="selectAll_<?php echo $i?>" />
					&nbsp; <a href="#" onClick="javascript:removeBooks();"><img  src="<?php echo $this->getSkinUrl('images/remove_button.png');?>" align="absmiddle" alt="<?php echo $this->__('Remove Selected from Wishlist') ?>" /></a>&nbsp;
			  <?php  endif;  ?>
				</div>
				<?php if(!$this->isUserAdmin()): ?>
				<div class="padderLeft15px left" id="donationBooksCount_<?php echo $i?>"  name="donationBooksCount_<?php echo $i?>"  style="display:block"></div>
				<div class="padderLeft15px left" name="donationAmount_<?php echo $i?>"  id="donationAmount_<?php echo $i?>" style="display:block"></div>
			  <?php  endif;  ?>
				<br/></li>

			</div><!-- leftArea -->
			<div class="rightArea">
				<div class="topPaginationArea">
					<ul>
						<?php if ($i!=1): ?>
							<li><a href="javascript:showPage('<?php echo $i-1 ?>')" id="prev"><?php echo $this->__('Prev') ?></a></li>
						<?php else: ?>
							<li class="nolink"><?php echo $this->__('Prev') ?></li>
						<?php endif; ?>
						
						<?php foreach ( $displayPages as $_page): ?>
							<?php if ($i==$_page): ?>
								<li><span><?php echo $_page ?></span></li>
							<?php else: ?>
								<li><a href="javascript:showPage('<?php echo $_page ?>')"><?php echo $_page ?></a></li>
							<?php endif ?>
						<?php endforeach; ?>

						<?php if ($i < $pages ): ?>
							<li><a href="javascript:showPage('<?php echo $i+1 ?>')"><?php echo $this->__('Next') ?></a></li>
						<?php else: ?>
							<li><b id="sep"><?php echo $this->__('Next') ?></b></li>
						<?php endif; ?>

					</ul>
				</div>
			</div><!-- rightArea -->
			<div class="clear"></div>
		</div><!-- searchResTop -->
			<?php echo $this->getBlockHtml('formkey')?>
			<table cellspacing="0" width="100%" class="custom-data-table box-table wishlist" id="wishlist-table">
			<col width="25"/>
			<col width="70"/>
			<col width="215"/>
			<col width="25"/>
			<col width="70"/>
			<col width="215"/>
			<col width="25"/>
			<col width="70"/>
			<col width="215"/>
			<tbody>
			<?php 
				
				$start=($i-1) * $pageSize;
				$end=($end = (($start + $pageSize)-1) ) >= $count ? ($count-1): $end ;
				
				for($j=$start;$j <= $end ; $j++ ){
					$item=$orgWishlist->getItemById($itemIds[$j]);
					$listPrice = (!is_null($item->getListPrice()))? $item->getListPrice() : 0;
					$discPrice = $item->getDiscountPrice();
					$savings= $listPrice - $discPrice;
					$savingsPerct= round(($listPrice >0 )? (($listPrice - $discPrice)/ $listPrice ) * 100 : 0);
					$stock=$item->getInStock();
				    if($counter%$columnSize==0){  
						if($firstTime!=0){  
?>							</tr>
<?php					}					?>
					<tr>
<?php				}
					$counter+=1;
?>
					<td>
						<input type="checkbox" onChange="javascript:addBookPrice(this,<?php echo $discPrice?>,<?php echo $i?>);" value="1" name="cart[<?php echo $item->getWishlistItemId() ?>][wishlist]" <?php if(!$this->isUserAdmin() && ($stock==0 || $listPrice <= 0)) : ?> disabled<?php endif;?> id="cart_item_<?php echo $item->getWishlistItemId() ?>" /> 
						<input type="hidden" value="<?php echo $discPrice?>" id="book_price_<?php echo $item->getWishlistItemId()?>"/> 
						<input type="hidden" value="<?php echo $item->getWishlistItemId()?>" name="book_id_<?php echo $i?>"/> 
					</td>
					<td>
						<div class="thumbnail"><a href="<?php echo $this->getUrl($item->getProductUrl()) ?>"><img src="<?php echo $this->helper('ekkitab_catalog')->resize($item->getImage(), 'thumbnail',false,null,74); ?>" class="img-border" alt="<?php echo $this->htmlEscape($item->getName()) ?>" /></a></div>
					</td>
					<td align="left">
						<div><a href="<?php echo $this->getUrl($item->getProductUrl()) ?>" title="<?php echo $this->htmlEscape($item->getName()) ?>"><?php echo $this->htmlEscape($item->getName()) ?></a></div>
						<?php if($discPrice > 0 && $stock!=0 && $listPrice > 0 ):?>
							<div class="youSave">Our Price: <?php echo Mage::helper('core')->currency($discPrice,true,false) ?> <!--<?php if($savingsPerct > 0):?><br/>Save: <?php echo $savingsPerct ?>%<?php endif; ?>--></div>
						<?php endif; ?>
						<?php if($listPrice > 0):?>
							<!--div class="lineHeight14em">MRP Price : <?php echo Mage::helper('core')->currency($listPrice,true,false) ?></div-->
						<?php endif; ?>
						<?php if($item->isSaleable()): ?>
							<!--a href="<?php echo $this->getItemAddToCartUrl($item,$_institute->getId()) ?>"><img src="<?php echo $this->getSkinUrl('images/move_cart_button_grey.png') ?>" alt="<?php echo $this->__('Add to Cart') ?>" class="v-middle"/></a><br/-->
						<?php endif; ?>

						<div class="youSave"><?php if($stock==0 || $listPrice <=0) : ?>Out of Stock<?php endif;?> </div><br/>
					</td>
<?php			$firstTime =1;
			}
			if($counter%$columnSize==1){ ?>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
<?php		}
			if($counter%$columnSize==2){ ?>
				<td></td>
				<td></td>
				<td></td>
<?php		}				?>

			</tr>
		</tbody>
		<input type="hidden" value=" <?php echo $_institute->getId()?>" name="org"/> 
		<input type="hidden" value=" <?php echo $_institute->getAdminId()?>" name="adminId"/> 
	</table>
		<script type="text/javascript">decorateTable('wishlist-table')</script>
		<div class="content" style="text-align:left">
				<?php if($this->isSaleable() && !$this->isUserAdmin()):?>
					&nbsp; &nbsp; <input type="image" src="<?php echo $this->getSkinUrl('images/donate_bks_selected.jpg');?>" alt="<?php echo $this->__('Donate Selected to Cart') ?>" />&nbsp;
				<?php endif;?> 
				<?php if($this->isUserAdmin()): ?>
					&nbsp; <a href="#" onClick="javascript:removeBooks();"><img  src="<?php echo $this->getSkinUrl('images/remove_button.png');?>" align="absmiddle" alt="<?php echo $this->__('Remove Selected from Wishlist') ?>" /></a>&nbsp;
			  <?php  endif;  ?>
				<br/></li>
				<br/>&nbsp; &nbsp;<a href="<?php echo $this->getBackUrl() ?>" >&laquo; <?php echo $this->__('Back') ?></a></li>
		</div>
	</div><!-- school_wishlist_page -->
<?php } ?>
</form>

<?php  else: ?>
	<?php if($_institute->getAnyDonation()): ?>
		 <div class="wishlistHdr"><?php echo $this->__("We welcome any book donation. ") ?></div>
		<div class="clear"></div>
		We do not have any specific need right now. We welcome any book donation of your choice to our library. For this you can use the school's address(provided above) as the shipping address instead of yours during the checkout.</span>
	<?php  else: ?>
		<div class="wishlistHdr">&nbsp;<?php echo $this->__("Our Library Needs") ?></div>
		<p><?php echo $this->__("There are no books added to %s's wishlist",$_institute->getName()) ?></p>
		<div class="button-set">
			<a href="<?php echo $this->getBackUrl() ?>" class="f-left">&laquo; <?php echo $this->__('Back') ?></a>
		</div>
	<?php endif; ?>
<?php endif ?>
<?php if($orgWishlist->getSize() && $_institute->getAnyDonation()): ?>
	<a name="anydonation"></a>
	<div class="menuSep"></div><br/>
	 <div class="wishlistHdr"><?php echo $this->__("We welcome any book donation. ") ?></div>
		<span class="greyTxtIt">Use the school's address(provided above) as the shipping address instead of yours during the checkout.</span>
<?php endif;?>

	</div><!-- midArea -->
	
	<!--div class="buyArea">
		<?php echo $this->getChildHtml('donate_book_blurb') ?>
	</div-->

	<!-- buyArea -->

	<div class="clear"></div>
</div><!-- searchArea -->
	<script type="text/javascript">
	//<![CDATA[
		var productAddToCartForm = new VarienForm('product_addtocart_form');
		productAddToCartForm.submit = function() {
			if(this.validator.validate()) {
				this.form.submit();
			}
		}.bind(productAddToCartForm);
	//]]>
	</script>
<br /><br />
<?php } else { ?>
	<div class="notFoundArea">
		<div class="pageHeader">Our Apologies...</div>
		<p> <div class="boldFont"> The content you have requested for is not available.</div>
		<ul>

		<li>If you typed the URL directly, please make sure that the spelling is correct.</li>
		<li>If you clicked on a link to get here, the link might be outdated</li></ul>
		</p>
		<p><div class="boldFont">What can you do?</div>
		Please contact Customer Care at  <a href="mailto:support@ekkitab.com">support@ekkitab.com</a> and let us know of this problem. We appreciate your help in ensuring that the service is available and runs error free.
		<ul>
		<li>Go <a href="javascript:history.back();">back to the previous page</a></li>
		<li>Use the Search Facility at the top of the page to search the ekkitab web site</li>
		<li>Click on any of the links below to get you back on track
		<ul><li><a href="<?php echo $this->getUrl('home')?>">ekkitab Home Page</a></li>
		<li><a href="<?php echo $this->getUrl('customer/account')?>">My Account</a> (You will have to Sign in or Register, if it's your first time)</li>
		</ul>
		</li></ul>
		</p>
	</div><!-- notFoundArea -->
<?php }?>


<script language="javascript">
	function showPage(pageNo){
		for(i=1;i<=totalPageCount;i++){
			var dataDivName = "school_wishlist_page_"+i;
			var obj = document.getElementById(dataDivName);
			var ua = navigator.userAgent.toLowerCase();
			if(obj){
				if(i!=pageNo){
					obj.style.display ="none";
				}else{
					obj.style.display ="block";
				}
			}	
		}
		addBookPrice(true,0,pageNo);
	}
	
	function removeBooks(){
		var frm= document.school_wishlist_books;
		frm.action="<?php echo $this->getRemoveSelectedWishlistUrl()?>";
		frm.submit();
	}


	function selectAllBooks(pageNo){
		var obj = document.getElementById("selectAll_"+pageNo);
		var idName="book_id_"+pageNo;
		var ids =eval("document.school_wishlist_books."+idName);
		if(obj){
			var size;
			if(ids && ids.value){
				size=1;
			}else{
				size=ids.length;
			}
			var alterCounter =false;
			if(size > 0){
				for(i=0;i<size;i++){
					if(size==1){
						var itemId = ids.value;
					}else{
						var itemId = ids[i].value;
					}
					var checkBox = document.getElementById("cart_item_"+itemId);
					var priceItem = document.getElementById("book_price_"+itemId);
					if(checkBox.disabled==false){
						if(checkBox.checked!=obj.checked){
							alterCounter = true;
						}
						if(obj.checked==false){
							checkBox.checked=false;
						}else{
							checkBox.checked=true;
						}
						if(alterCounter){
							addBookPrice(checkBox,priceItem.value,pageNo);
						}
					} 
				}
			}
		}
	}
	function addBookPrice(obj,price,pageNo){
		var itemsCounterObj = document.getElementById("donationBooksCount_"+pageNo);
		var donationCounter =document.getElementById("donationAmount_"+pageNo);
		var price = parseInt(price);
		if(itemsCounterObj  &&  donationCounter){
			if(price > 0 && obj){
				if(obj.checked){
					totalDonationCost = totalDonationCost + price ;
					totalDonationCartItems = totalDonationCartItems + 1 ;
				}else {
					totalDonationCost = totalDonationCost - price ;
					totalDonationCartItems = totalDonationCartItems - 1 ;
				}
			}
			if(totalDonationCartItems > 0){
				itemsCounterObj.innerHTML="<b>Books Selected :</b> <span class='orangeTxt'>"+totalDonationCartItems+"</span>";
				itemsCounterObj.style.display="block";
			}else{
				itemsCounterObj.innerHTML="";
				itemsCounterObj.style.display="none";
			}
			if(totalDonationCost > 0) {
				donationCounter.innerHTML="<b>Donation Cart Total :</b> <span class='orangeTxt'>"+totalDonationCost+"</span>";
				donationCounter.style.display="block";
			}else{
				donationCounter.innerHTML="";
				donationCounter.style.display="none";
			}
		}
	}

	function showWishlistForm(){
		var wishlistFormDiv = document.getElementById("wishlistForm");
		wishlistFormDiv.style.display="block";
	}
	function gotoWishlistForm(){
		location.href='#updateWishlistForm';
	}

</script>

