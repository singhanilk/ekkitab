#!/bin/bash
if [ -z $EKKITAB_HOME ] ; then
    echo "EKKITAB_HOME is not set..."
    exit 1;
fi;
if (( $# < 1 )) ; then
    echo "Require entity name. (catalog or app)"
    echo "Usage: $0 <entity>"
    exit 1;
fi
entity=`echo $1 | tr A-Z a-z`
shift;

tomail=""
while [ $# -gt 0 ] ; do 
    tomail="$tomail $1"
    shift
done 

if [ "$tomail" == "" ] ; then
    tomail=vijay@ekkitab.com # Default recipient
fi

releasedir=$EKKITAB_HOME/release 
runcommand="";
case "$entity" in 
    catalog ) ( cd $EKKITAB_HOME/bin; ./gencatalog.sh );
              success=$?;
              runcommand=synchcatalog.sh;
              ;;
    app )     ( cd $EKKITAB_HOME/bin; ./genrelease.sh );
              success=$?;
              runcommand=synchrelease.sh;
              ;;
    * )       echo "[Fatal] Unknown entity '$entity'";
              exit 1;
              ;;
esac

if (( $success > 0 )) ; then
   echo "[Fatal] Generation of $entity failed."
   exit 1;
fi

cd $releasedir;

echo "Transferring $entity to production server."
echo -n "Deleting tranfer target on production server..."
ssh -n prod "cd /tmp; rm -rf $entity"
echo "done."
echo -n "Transferring new $entity to production server..."
( cd $releasedir; scp -r $entity prod:/tmp >/dev/null )
echo "done."
echo "Deploying new $entity on production server."
ssh prod "/mnt2/scm/bin/launch_release_on_production $entity $tomail"
