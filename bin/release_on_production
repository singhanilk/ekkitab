#!/bin/bash
if [ -z $EKKITAB_HOME ] ; then
    echo "EKKITAB_HOME is not set..."
    exit 1;
fi;
if (( $# < 1 )) ; then
    echo "Require entity name. (catalog or app)"
    echo "Usage: $0 <entity>"
    exit 1;
fi
entity=`echo $1 | tr A-Z a-z`
runcommand="";
case "$entity" in 
    catalog ) runcommand=synchcatalog.sh;
              ;;
    app )     runcommand=synchrelease.sh;
              ;;
    * )       echo "[Fatal] Unknown entity '$entity'";
              exit 1;
              ;;
esac

ZERO_SESSIONS_THRESHOLD=0
activesessions=`$EKKITAB_HOME/bin/getactivesessions.sh`;
tries=0;
MAXTRIES=30;
while (( $activesessions > $ZERO_SESSIONS_THRESHOLD )) && (( $tries < $MAXTRIES )) ; do
(( tries++ ));
echo "Sleeping. $activesessions sessions are active."
sleep 60;
activesessions=`$EKKITAB_HOME/bin/getactivesessions.sh`;
done;
if (( $activesessions <= $ZERO_SESSIONS_THRESHOLD )) ; then
    cd /tmp/$entity;
    ./$runcommand;
    sleep 10;
    php $EKKITAB_HOME/bin/samplesearch.php
    echo "New $entity is now in production.";
    echo "Deleting image cache...";
    rm -rf $EKKITAB_HOME/magento/media/catalog/product/cache/1/*
else
    echo "Production system has active sessions. Wait timed out. New $entity is NOT pushed to production." 
fi;
